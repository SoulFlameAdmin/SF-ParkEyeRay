<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="utf-8" />
<title>üÖø –ü–∞—Ä–∫–æ–º–µ—Å—Ç–∞ ‚Äî –≥—Ä–∞–¥–æ–≤–µ ¬∑ –∫–≤–∞—Ä—Ç–∞–ª–∏ ¬∑ OSM (P)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  :root{
    --text:#0f172a; --muted:#6b7280; --line:#e5e7eb; --pill:#eef2ff; --pillb:#dbe2ff; --ink:#111827;
  }
  *{box-sizing:border-box}
  body{margin:0;font:14px/1.45 system-ui,Segoe UI,Roboto,Arial;color:var(--text);background:#fff}
  header{position:sticky;top:0;z-index:3;background:var(--ink);color:#fff;border-bottom:1px solid #000}
  header .wrap{max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;gap:12px;align-items:center}
  .brand{font-weight:800}
  .meta{font-size:12px;opacity:.85}
  main{max-width:1200px;margin:0 auto;padding:14px}
  .toolbar{display:flex;gap:8px;margin-bottom:10px;align-items:center;flex-wrap:wrap}
  .toolbar input{flex:1 1 260px;padding:10px 12px;border:1px solid var(--line);border-radius:10px}
  .toolbar button{padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
  .grid{display:grid;grid-template-columns:minmax(260px,1fr) minmax(260px,1fr) 1.4fr;gap:12px;align-items:start}
  .panel{border:1px solid var(--line);border-radius:12px;background:#fff;overflow:hidden}
  .panel header{background:#f9fafb;border-bottom:1px solid var(--line);color:#111}
  .panel header .ttl{padding:10px 12px;font-weight:700}
  .list{max-height:75vh;overflow:auto}
  .row{padding:10px 12px;border-bottom:1px solid #f1f5f9;display:flex;justify-content:space-between;gap:10px;cursor:pointer}
  .row:hover{background:#f8fafc}
  .name{font-weight:700}
  .pill{font-size:12px;background:var(--pill);border:1px solid var(--pillb);color:#2332a2;border-radius:999px;padding:2px 8px;white-space:nowrap}
  .empty{padding:12px;color:var(--muted)}
  .places{max-height:75vh;overflow:auto}
  .place{padding:10px 12px;border-bottom:1px dashed var(--line)}
  .place a{color:#0f766e;text-decoration:none}
  .place a:hover{text-decoration:underline}
  #map{height:75vh;border:1px solid var(--line);border-radius:12px}
  .hint{margin-top:8px;color:var(--muted);font-size:12px}
  .picon{
    width:22px;height:22px;border-radius:6px;border:1px solid #334155;background:#e2e8f0;
    display:flex;align-items:center;justify-content:center;font:bold 13px/1 system-ui;color:#111
  }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">üÖø –ü–∞—Ä–∫–æ–º–µ—Å—Ç–∞ ‚Äî –ù–∞—Ü–∏–æ–Ω–∞–ª–Ω–∞ –∫–∞—Ä—Ç–∞ (P=amenity=parking)</div>
    <div class="meta" id="meta">–ó–∞—Ä–µ–∂–¥–∞–º‚Ä¶</div>
  </div>
</header>

<main>
  <div class="toolbar">
    <input id="q" placeholder="–¢—ä—Ä—Å–∏ –≥—Ä–∞–¥‚Ä¶" />
    <button id="btnReloadCity" title="–û–ø—Ä–µ—Å–∏ –ø–∞—Ä–∫–∏–Ω–≥–∏—Ç–µ –∑–∞ –∏–∑–±—Ä–∞–Ω–∏—è –≥—Ä–∞–¥">–û–ø—Ä–µ—Å–∏</button>
    <button id="btnOverpass" title="–û—Ç–≤–æ—Ä–∏ –∑–∞—è–≤–∫–∞—Ç–∞ –≤ Overpass Turbo" disabled>Overpass</button>
    <span class="hint" id="hint">–î–∞–Ω–Ω–∏ –∑–∞ –≥—Ä–∞–¥–æ–≤–µ/–∫–≤–∞—Ä—Ç–∞–ª–∏: E:\Parking_app\257_cities_bulgaria_corrected.txt ¬∑ –ü–∞—Ä–∫–∏–Ω–≥–∏: OSM/Overpass</span>
  </div>

  <div class="grid">
    <!-- –ì—Ä–∞–¥–æ–≤–µ -->
    <section class="panel">
      <header><div class="ttl" id="citiesTitle">–ì—Ä–∞–¥–æ–≤–µ (‚Äî)</div></header>
      <div id="cities" class="list"><div class="empty">–ó–∞—Ä–µ–∂–¥–∞–º —Å–ø–∏—Å—ä–∫ —Å –≥—Ä–∞–¥–æ–≤–µ‚Ä¶</div></div>
    </section>

    <!-- –ö–≤–∞—Ä—Ç–∞–ª–∏ -->
    <section class="panel">
      <header><div class="ttl" id="districtsTitle">–ö–≤–∞—Ä—Ç–∞–ª–∏ ‚Äî –∏–∑–±–µ—Ä–∏ –≥—Ä–∞–¥</div></header>
      <div id="districts" class="list"><div class="empty">–ù—è–º–∞ –¥–∞–Ω–Ω–∏ ‚Äî –∫–ª–∏–∫–Ω–∏ –≥—Ä–∞–¥ –≤–ª—è–≤–æ.</div></div>
    </section>

    <!-- –ü–∞—Ä–∫–∏–Ω–≥–∏ (—Å–ø–∏—Å—ä–∫) -->
    <section class="panel">
      <header><div class="ttl" id="placesTitle">–ü–∞—Ä–∫–∏–Ω–≥–∏ ‚Äî –∏–∑–±–µ—Ä–∏ –∫–≤–∞—Ä—Ç–∞–ª</div></header>
      <div id="places" class="places"><div class="empty">‚Äî</div></div>
    </section>
  </div>

  <!-- –ö–∞—Ä—Ç–∞ -->
  <section class="panel" style="margin-top:12px">
    <header><div class="ttl" id="mapTitle">–ö–∞—Ä—Ç–∞ ‚Äî –≤—Å–∏—á–∫–∏ –ø–∞—Ä–∫–∏–Ω–≥–∏ (P) –∑–∞ –∏–∑–±—Ä–∞–Ω–∏—è –≥—Ä–∞–¥</div></header>
    <div id="map"></div>
  </section>
</main>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ===================== –ö–æ–Ω—Ñ–∏–≥ ===================== */
const ABS_FILE_URL = "file:///E:/Parking_app/257_cities_bulgaria_corrected.txt";  // –¥–∏—Ä–µ–∫—Ç–µ–Ω –ª–æ–∫–∞–ª–µ–Ω —Ñ–∞–π–ª
const REL_FILE_URL = "257_cities_bulgaria_corrected.txt";                         // fallback –ø—Ä–∏ –ª–æ–∫–∞–ª–µ–Ω —Å—ä—Ä–≤—ä—Ä
const OVERPASS     = "https://overpass-api.de/api/interpreter";

/* ===================== –°—ä—Å—Ç–æ—è–Ω–∏–µ ===================== */
let CITY_INDEX = [];        // [{name, districts:[]}]
let CITY_TO_DISTRICTS = {}; // name -> string[]
let CURRENT_CITY = null;
let CITY_FEATURES = [];

/* ===================== –£—Ç–∏–ª–∏—Ç–∏ ===================== */
const $ = (id)=>document.getElementById(id);
const byBg = (a,b)=>a.localeCompare(b,'bg');
function setMeta(txt){ $('meta').textContent = txt; }
function setHint(txt){ $('hint').textContent = txt; }

/* –ü—Ä–æ—á–∏—Ç –Ω–∞ —Ç–µ–∫—Å—Ç–∞ (UTF-8 / windows-1251) */
async function fetchText(url){
  const res = await fetch(url, {cache:'no-cache'});
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const buf = await res.arrayBuffer();
  try { return new TextDecoder('utf-8',{fatal:true}).decode(buf); }
  catch { return new TextDecoder('windows-1251').decode(buf); }
}

/* ===================== –ü–∞—Ä—Å–≤–∞–Ω–µ –Ω–∞ TXT ===================== */
function parseCitiesTxt(text){
  const lines = text.split(/\r?\n/);
  const dict = {};
  const cities = [];
  let currentCity = null;

  const pushCity = (name)=>{
    name = (name||'').trim();
    if(!name) return;
    if(!dict[name]) dict[name] = [];
    if(!cities.find(c=>c.name===name)) cities.push({name, districts: dict[name]});
    currentCity = name;
  };

  for(const raw of lines){
    if(raw==null) continue;
    let line = String(raw).replace(/^[\uFEFF]+/,'').trim();
    if(!line) continue;
    if(/^_{3,}$/.test(line)) continue;

    // "–ì—Ä–∞–¥: –∫–≤1, –∫–≤2" (–ø–æ–¥–¥—ä—Ä–∂–∞ : ‚Äî - | ; ,)
    if(/[Ôºö:‚Äî\-|]/.test(line) && !/^\s/.test(raw)){
      const m = line.split(/[:‚Äî\-|]/);
      const city = (m.shift()||'').trim();
      pushCity(city);
      const rest = m.join(' ').trim();
      if(rest){
        rest.split(/[;,|]/).map(s=>s.trim()).filter(Boolean).forEach(d=>{
          if(!dict[currentCity].includes(d)) dict[currentCity].push(d);
        });
      }
      continue;
    }

    // –ò–º–µ –Ω–∞ –≥—Ä–∞–¥ (—Ä–µ–¥ –±–µ–∑ –æ—Ç—Å—Ç—ä–ø/–º–∞—Ä–∫–µ—Ä)
    if(!/^\s/.test(raw) && !/^[‚Ä¢¬∑\-‚Äì‚Äî]/.test(line)){
      pushCity(line);
      continue;
    }

    // –ö–≤–∞—Ä—Ç–∞–ª (—Ä–µ–¥ —Å –æ—Ç—Å—Ç—ä–ø –∏–ª–∏ –º–∞—Ä–∫–µ—Ä)
    const district = line.replace(/^[-‚Äì‚Äî‚Ä¢¬∑]+/,'').trim();
    if(district && currentCity){
      if(!dict[currentCity].includes(district)) dict[currentCity].push(district);
    }
  }

  cities.sort((a,b)=>byBg(a.name,b.name));
  cities.forEach(c=>c.districts = [...new Set(c.districts)].sort(byBg));
  return {cities, dict};
}

/* ===================== Overpass ===================== */
async function findAreaIdByName(name){
  // –¢—ä—Ä—Å–∏ –ø–æ name, name:bg –∏ name:en (–Ω—è–∫–æ–∏ —Ä–µ–ª–∞—Ü–∏–∏ —Å–∞ —Å –ª–∞—Ç–∏–Ω–∏—Ü–∞)
  const q = `
    [out:json][timeout:40];
    area["ISO3166-1"="BG"]->.bg;
    (
      relation["boundary"="administrative"]["name"="${name}"](area.bg);
      relation["boundary"="administrative"]["name:bg"="${name}"](area.bg);
      relation["boundary"="administrative"]["name:en"="${name}"](area.bg);
      area["boundary"="administrative"]["name"="${name}"](area.bg);
    );
    out ids qt;`;
  const r = await fetch(OVERPASS,{method:'POST',body:new URLSearchParams({data:q})});
  const j = await r.json();
  if(!j.elements?.length) return null;
  const el = j.elements[0];
  return el.type==='area' ? el.id : 3600000000 + el.id;
}

async function getParkingsInArea(areaId){
  // –í–°–ò–ß–ö–ò P –ø–∞—Ä–∫–∏–Ω–≥–∏ (–±–µ–∑ access —Ñ–∏–ª—Ç—ä—Ä) + –≥–µ–æ–º–µ—Ç—Ä–∏—è
  const q = `
    [out:json][timeout:90];
    area(${areaId})->.a;
    (
      node["amenity"="parking"](area.a);
      way["amenity"="parking"](area.a);
      relation["amenity"="parking"](area.a);
    );
    out ids center tags geom;`;
  const r = await fetch(OVERPASS,{method:'POST',body:new URLSearchParams({data:q})});
  const j = await r.json();
  return j.elements || [];
}

function osmUrlFor(el){
  if(el.type==='node') return `https://www.openstreetmap.org/node/${el.id}`;
  if(el.type==='way')  return `https://www.openstreetmap.org/way/${el.id}`;
  return `https://www.openstreetmap.org/relation/${el.id}`;
}

function overpassUrlForCity(city){
  const q = `[out:json][timeout:90];
area["ISO3166-1"="BG"]->.bg;
area(area.bg)["boundary"="administrative"]["name"="${city}"]->.a;
(
  node["amenity"="parking"](area.a);
  way["amenity"="parking"](area.a);
  relation["amenity"="parking"](area.a);
);
out ids center tags geom;`;
  return `https://overpass-turbo.eu/?Q=${encodeURIComponent(q)}`;
}

/* ===================== –ö–∞—Ä—Ç–∞ ===================== */
let MAP, markersLayer, polygonsLayer, pIcon;

function initMap(){
  if(MAP) return;
  MAP = L.map('map').setView([42.7,25.3], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
  }).addTo(MAP);
  polygonsLayer = L.layerGroup().addTo(MAP);
  markersLayer  = L.layerGroup().addTo(MAP);
  pIcon = L.divIcon({className:'picon', html:'P', iconSize:[22,22], iconAnchor:[11,11]});
}

function popupHtml(el){
  const t = el.tags || {};
  const type = t.parking ? ` (${t.parking})` : '';
  const op   = t.operator ? `<div class="muted">–û–ø–µ—Ä–∞—Ç–æ—Ä: ${t.operator}</div>` : '';
  const url  = osmUrlFor(el);
  const name = t.name || '–ü–∞—Ä–∫–∏–Ω–≥';
  return `<b>${name}${type}</b><br/><a href="${url}" target="_blank" rel="noopener">OSM ‚Üí</a>${op}`;
}

function drawParkings(features){
  initMap();
  polygonsLayer.clearLayers();
  markersLayer.clearLayers();
  const bounds = L.latLngBounds();

  features.forEach(el=>{
    // –ü–æ–ª–∏–≥–æ–Ω (way/relation)
    if((el.type==='way' || el.type==='relation') && Array.isArray(el.geometry) && el.geometry.length){
      const latlngs = el.geometry.map(g => [g.lat, g.lon]);
      const poly = L.polygon(latlngs);
      poly.bindPopup(popupHtml(el));
      poly.addTo(polygonsLayer);
      latlngs.forEach(ll => bounds.extend(ll));
      return;
    }
    // –¢–æ—á–∫–∞ (node –∏–ª–∏ center)
    const lat = el.lat ?? el.center?.lat;
    const lon = el.lon ?? el.center?.lon;
    if(lat!=null && lon!=null){
      const m = L.marker([lat,lon], {icon:pIcon});
      m.bindPopup(popupHtml(el));
      m.addTo(markersLayer);
      bounds.extend([lat,lon]);
    }
  });

  if (bounds.isValid()){
    MAP.fitBounds(bounds.pad(0.15));
  }
}

/* ===================== –†–µ–Ω–¥–µ—Ä–∏ ===================== */
function renderCities(list){
  const root = $('cities');
  root.innerHTML = '';
  if(!list.length){ root.innerHTML = `<div class="empty">–ù—è–º–∞ –≥—Ä–∞–¥–æ–≤–µ.</div>`; return; }

  list.forEach(item=>{
    const div = document.createElement('div');
    div.className = 'row';
    div.innerHTML = `<div class="name">${item.name}</div>
                     <div class="pill">${item.districts.length} –∫–≤.</div>`;
    div.addEventListener('click',()=>openCity(item.name));
    root.appendChild(div);
  });
  $('citiesTitle').textContent = `–ì—Ä–∞–¥–æ–≤–µ (${list.length})`;
}

function renderDistricts(cityName, pairs){
  $('districtsTitle').textContent = `–ö–≤–∞—Ä—Ç–∞–ª–∏ ‚Äî ${cityName}`;
  const root = $('districts'); root.innerHTML='';
  if(!pairs.length){ root.innerHTML = `<div class="empty">–ù—è–º–∞ –≤—ä–≤–µ–¥–µ–Ω–∏ –∫–≤–∞—Ä—Ç–∞–ª–∏.</div>`; return; }
  pairs.sort((a,b)=>byBg(a.name,b.name)).forEach(d=>{
    const div = document.createElement('div');
    div.className='row';
    div.innerHTML = `<div class="name">${d.name}</div>
                     <div class="pill">${d.count ?? 0}</div>`;
    div.addEventListener('click',()=>openDistrict(d.name));
    root.appendChild(div);
  });
}

function renderPlaces(city, districtName){
  $('placesTitle').textContent = `–ü–∞—Ä–∫–∏–Ω–≥–∏ ‚Äî ${city} ¬∑ ${districtName}`;
  const root = $('places'); root.innerHTML='';
  const features = CITY_FEATURES.filter(el=>{
    const t = el.tags||{};
    const d = t['addr:suburb'] || t['addr:neighbourhood'] || t['addr:district'] || '–ë–µ–∑ –∫–≤–∞—Ä—Ç–∞–ª';
    return d === districtName;
  });
  if(!features.length){ root.innerHTML = `<div class="empty">–ù—è–º–∞ –ø–∞—Ä–∫–∏–Ω–≥–∏ –∑–∞ —Ç–æ–∑–∏ –∫–≤–∞—Ä—Ç–∞–ª.</div>`; return; }

  features
    .sort((a,b)=>byBg(a.tags?.name||'', b.tags?.name||''))
    .forEach(el=>{
      const name = el.tags?.name || '–ü–∞—Ä–∫–∏–Ω–≥';
      const type = el.tags?.parking ? ` (${el.tags.parking})` : '';
      const row = document.createElement('div');
      row.className = 'place';
      row.innerHTML = `<div><b>${name}</b><span class="muted">${type}</span></div>
                       <div class="muted"><a href="${osmUrlFor(el)}" target="_blank" rel="noopener">OSM ‚Üí</a></div>`;
      root.appendChild(row);
    });
}

/* ===================== –î–µ–π—Å—Ç–≤–∏—è ===================== */
async function openCity(cityName){
  $('districts').innerHTML = `<div class="empty">–ó–∞—Ä–µ–∂–¥–∞–º –∫–≤–∞—Ä—Ç–∞–ª–∏ –∏ –ø–∞—Ä–∫–∏–Ω–≥–∏ –∑–∞ ${cityName}‚Ä¶</div>`;
  $('places').innerHTML    = `<div class="empty">–ò–∑–±–µ—Ä–∏ –∫–≤–∞—Ä—Ç–∞–ª –æ—Ç —Å—Ä–µ–¥–Ω–∞—Ç–∞ –∫–æ–ª–æ–Ω–∞.</div>`;
  $('placesTitle').textContent = `–ü–∞—Ä–∫–∏–Ω–≥–∏ ‚Äî –∏–∑–±–µ—Ä–∏ –∫–≤–∞—Ä—Ç–∞–ª`;
  $('mapTitle').textContent = `–ö–∞—Ä—Ç–∞ ‚Äî –≤—Å–∏—á–∫–∏ –ø–∞—Ä–∫–∏–Ω–≥–∏ (P) –∑–∞ ${cityName}`;
  CURRENT_CITY = {name: cityName};
  $('btnOverpass').disabled = false;
  $('btnOverpass').onclick = ()=>window.open(overpassUrlForCity(cityName),'_blank','noopener');

  // 1) –ö–≤–∞—Ä—Ç–∞–ª–∏—Ç–µ –æ—Ç —Ñ–∞–π–ª–∞
  const fileDistricts = (CITY_TO_DISTRICTS[cityName] || []).slice();

  // 2) –ü–∞—Ä–∫–∏–Ω–≥–∏—Ç–µ –æ—Ç OSM
  try{
    const areaId = await findAreaIdByName(cityName);
    if(!areaId){
      renderDistricts(cityName, fileDistricts.map(n=>({name:n,count:0})));
      drawParkings([]); setMeta(`–ù–µ –Ω–∞–º–µ—Ä–∏—Ö –≥—Ä–∞–Ω–∏—Ü–∞ –∑–∞ ${cityName}.`); return;
    }

    const els = await getParkingsInArea(areaId);
    CURRENT_CITY.areaId = areaId;
    CITY_FEATURES = els;

    // –≥—Ä—É–ø–∏—Ä–∞–Ω–µ –ø–æ –∫–≤–∞—Ä—Ç–∞–ª –æ—Ç OSM
    const map = new Map();
    els.forEach(el=>{
      const t = el.tags||{};
      const d = t['addr:suburb'] || t['addr:neighbourhood'] || t['addr:district'] || '–ë–µ–∑ –∫–≤–∞—Ä—Ç–∞–ª';
      map.set(d, (map.get(d)||0)+1);
    });

    // –∫–æ–º–±–∏–Ω–∏—Ä–∞–Ω–µ: –ø—ä—Ä–≤–æ —Ä–µ–¥—ä—Ç –æ—Ç —Ñ–∞–π–ª–∞, –ø–æ—Å–ª–µ –∫–≤–∞—Ä—Ç–∞–ª–∏ —Å–∞–º–æ –æ—Ç OSM
    const pairs = []; const seen = new Set();
    fileDistricts.forEach(d=>{ pairs.push({name:d, count: map.get(d)||0}); seen.add(d); });
    map.forEach((count,d)=>{ if(!seen.has(d)) pairs.push({name:d, count}); });

    renderDistricts(cityName, pairs);
    drawParkings(els);
    setMeta(`–û–±–Ω–æ–≤–µ–Ω–æ: ${new Date().toLocaleString('bg-BG')} ¬∑ –ü–∞—Ä–∫–∏–Ω–≥–∏ –≤ ${cityName}: ${els.length.toLocaleString('bg-BG')}`);
  }catch(err){
    renderDistricts(cityName, fileDistricts.map(n=>({name:n,count:0})));
    drawParkings([]);
    setMeta(`–ì—Ä–µ—à–∫–∞ –æ—Ç Overpass –∑–∞ ${cityName}. –û–ø–∏—Ç–∞–π –ø–∞–∫.`);
  }
}

function openDistrict(name){
  if(!CURRENT_CITY) return;
  renderPlaces(CURRENT_CITY.name, name);
  const filtered = CITY_FEATURES.filter(el=>{
    const t = el.tags||{};
    const d = t['addr:suburb'] || t['addr:neighbourhood'] || t['addr:district'] || '–ë–µ–∑ –∫–≤–∞—Ä—Ç–∞–ª';
    return d === name;
  });
  drawParkings(filtered);
}

/* –†—ä—á–µ–Ω —Ä–µ—Ñ—Ä–µ—à */
$('btnReloadCity').addEventListener('click', ()=>{
  if(CURRENT_CITY?.name){ openCity(CURRENT_CITY.name); }
});

/* ===================== –¢—ä—Ä—Å–µ–Ω–µ ===================== */
$('q').addEventListener('input', ()=>{
  const s = $('q').value.trim().toLowerCase();
  const list = !s ? CITY_INDEX : CITY_INDEX.filter(x=>x.name.toLowerCase().includes(s));
  renderCities(list);
});

/* ===================== –°—Ç–∞—Ä—Ç ===================== */
(async function start(){
  initMap();
  try{
    setMeta('–ß–µ—Ç–∞ –≥—Ä–∞–¥–æ–≤–µ/–∫–≤–∞—Ä—Ç–∞–ª–∏ –æ—Ç E:\\‚Ä¶');
    let txt;
    try { txt = await fetchText(ABS_FILE_URL); setHint('–§–∞–π–ª—ä—Ç –µ –∑–∞—Ä–µ–¥–µ–Ω –¥–∏—Ä–µ–∫—Ç–Ω–æ –æ—Ç E:\\'); }
    catch { txt = await fetchText(REL_FILE_URL); setHint('–§–∞–π–ª—ä—Ç –µ –∑–∞—Ä–µ–¥–µ–Ω –ø—Ä–µ–∑ –ª–æ–∫–∞–ª–µ–Ω —Å—ä—Ä–≤—ä—Ä.'); }

    const {cities, dict} = parseCitiesTxt(txt);
    CITY_INDEX = cities; CITY_TO_DISTRICTS = dict;
    renderCities(CITY_INDEX);
    setMeta(`–ì—Ä–∞–¥–æ–≤–µ –∑–∞—Ä–µ–¥–µ–Ω–∏: ${CITY_INDEX.length}`);
  }catch(err){
    $('cities').innerHTML = `<div class="empty">–ù–µ —É—Å–ø—è—Ö –¥–∞ –ø—Ä–æ—á–µ—Ç–∞ —Ñ–∞–π–ª–∞. –°—Ç–∞—Ä—Ç–∏—Ä–∞–π Edge/Chrome —Å —Ñ–ª–∞–≥
      <code>--allow-file-access-from-files</code> –∏–ª–∏ –ø—É—Å–Ω–∏ <code>npx serve -p 5500</code>, –ø–æ—Å–ª–µ –æ—Ç–≤–æ—Ä–∏
      <code>http://localhost:5500/parkomesta.html</code>.</div>`;
    setMeta('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —á–µ—Ç–µ–Ω–µ –Ω–∞ —Ñ–∞–π–ª–∞.');
  }
})();

/* ===================================================================
   Worker API –∑–∞ map2.html:
   - –ü—Ä–∏–µ–º–∞ postMessage {type:'SEARCH_PARKINGS', payload:{lat,lon}}
   - –ù–∞–º–∏—Ä–∞ –∞–¥–º–∏–Ω. –æ–±–ª–∞—Å—Ç (is_in), —Ç–µ–≥–ª–∏ –í–°–ò–ß–ö–ò amenity=parking (out geom)
   - –í—Ä—ä—â–∞ –∫—ä–º —Ä–æ–¥–∏—Ç–µ–ª—è: {type:'PARKINGS_RESULT', count, features}
   =================================================================== */
window.addEventListener('message', async (e)=>{
  const msg = e.data || {};
  if(msg.type !== 'SEARCH_PARKINGS') return;
  const {lat, lon} = msg.payload || {};
  if(!Number.isFinite(lat) || !Number.isFinite(lon)){
    return parent.postMessage({type:'PARKINGS_ERROR', message:'–ù–µ–≤–∞–ª–∏–¥–Ω–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏'}, '*');
  }
  try{
    const areaId = await findAdminAreaByPoint(lat, lon);
    let features = [];
    if(areaId){
      features = await getParkingsInArea(areaId);
    }else{
      features = await getParkingsAround(lat, lon, 5000); // fallback 5 –∫–º —Ä–∞–¥–∏—É—Å
    }
    parent.postMessage({type:'PARKINGS_RESULT', count: features.length, features}, '*');
  }catch(err){
    parent.postMessage({type:'PARKINGS_ERROR', message: err?.message || '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—è–≤–∫–∞'}, '*');
  }
});

// –ù–∞–º–µ—Ä–∏ –ø–æ–¥—Ö–æ–¥—è—â–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞ AREA –∑–∞ —Ç–æ—á–∫–∞—Ç–∞
async function findAdminAreaByPoint(lat, lon){
  const q = `
    [out:json][timeout:50];
    is_in(${lat},${lon})->.a;
    area.a["boundary"="administrative"]->.all;
    (.all;);
    out ids tags;`;
  const els = await overpass(q);
  if(!els.length) return null;
  // –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è: admin_level 6 (–æ–±—â–∏–Ω–∞) > 8 (–Ω–∞—Å. –º—è—Å—Ç–æ) > 7 > 5 > –¥—Ä—É–≥–∏
  const pick = els
    .filter(e=>e.type==='area')
    .map(e=>{
      const al = e.tags?.admin_level;
      let score = 10;
      if(al==='6') score = 100;
      else if(al==='8') score = 80;
      else if(al==='7') score = 70;
      else if(al==='5') score = 60;
      return {id:e.id, score};
    })
    .sort((a,b)=>b.score-a.score)[0];
  return pick?.id || null;
}

async function getParkingsAround(lat, lon, radius){
  const q = `
    [out:json][timeout:60];
    (
      node(around:${radius},${lat},${lon})["amenity"="parking"];
      way(around:${radius},${lat},${lon})["amenity"="parking"];
      relation(around:${radius},${lat},${lon})["amenity"="parking"];
    );
    out ids center tags geom;`;
  return await overpass(q);
}

async function overpass(query){
  const r = await fetch(OVERPASS,{method:'POST', body:new URLSearchParams({data:query})});
  const j = await r.json();
  return j.elements || [];
}
</script>
</body>
</html>
